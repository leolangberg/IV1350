package se.kth.IV1350.progExe.controller;

import se.kth.IV1350.progExe.integration.CashRegister;
import se.kth.IV1350.progExe.integration.Printer;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import se.kth.IV1350.progExe.integration.external.*;
import se.kth.IV1350.progExe.integration.external.Exceptions.DatabaseException;
import se.kth.IV1350.progExe.model.RevenueObserver;
import se.kth.IV1350.progExe.model.SalesHandler;
import se.kth.IV1350.progExe.model.DTO.*;
import se.kth.IV1350.progExe.model.discount.CompositeDiscount;
import se.kth.IV1350.progExe.model.discount.Discount;
import se.kth.IV1350.progExe.model.Exceptions.SaleException;
import se.kth.IV1350.progExe.model.ENUM.PaymentType;

/**
 * The Controller class is responsible for handling all communication between
 * the view and the model.
 * 
 * This class contains methods for initiating a new sale, fetching items, ending
 * a sale, processing payments, and applying discounts.
 */
public class Controller {

    private ExternalAccountingSys externalAccountingSys;
    private ExternalInventorySys externalInventorySys;
    private ExternalDiscountSys externalDiscountSys;

    private SalesHandler salesHandler;
    private CashRegister cashRegister;
    private Printer printer;

    private List<RevenueObserver> observers = new ArrayList<>();

    /**
     * Constructs a new Controller object.
     * 
     * This constructor initializes the Controller with the provided external
     * systems, Printer, and cash register.
     *
     * @param externalAccountingSys The external accounting system to be used by the
     *                              Controller.
     * @param externalInventorySys  The external inventory system to be used by the
     *                              Controller.
     * @param externalDiscountSys   The external discount system to be used by the
     *                              Controller.
     * @param printer               The Printer to be used by the Controller.
     * @param cashRegister          The cash register to be used by the Controller.
     */
    public Controller(ExternalAccountingSys externalAccountingSys,
            ExternalInventorySys externalInventorySys, ExternalDiscountSys externalDiscountSys,
            Printer printer, CashRegister cashRegister) {

        this.externalAccountingSys = externalAccountingSys;
        this.externalDiscountSys = externalDiscountSys;
        this.externalInventorySys = externalInventorySys;

        this.printer = printer;
        this.cashRegister = cashRegister;

    };

    /**
     * Initiates a new sale.
     * 
     * This method creates a new SalesHandler object with a unique ID generated by
     * the external accounting system.
     * @return ID of new Sale.
     * @throws OperationFailedException in case a DatabaseException has been catched.
     */
    public int newSale() throws OperationFailedException {
        try{
            int saleID = externalAccountingSys.newID();
            salesHandler = new SalesHandler(saleID);
            for (RevenueObserver observer : observers) {
                salesHandler.addObserver(observer);
            }
            return saleID;
        } catch (DatabaseException dbe) {
            throw new OperationFailedException(dbe.getMessage(), dbe);
        }
    }

    /**
     * Adds an observer to the list of observers.
     * 
     * @param observer The observer to be added.
     */
    public void addObserver(RevenueObserver observer) {
        observers.add(observer);
        if (salesHandler != null) {
            salesHandler.addObserver(observer);
        }
    }


    /**
     * Fetches an item based on the provided item ID.
     *
     * @param itemID The ID of the item to fetch.
     * @return ItemPackageDTO contaning all relevant View Layer information
     *         (ItemDTO, Quantity, runningTotalCost, runningTotalVAT).
     * @throws OperationsFailedException in case an Excpetion is catched regarding either
     *                                   database calls or ongoing Sale.
     */
    public ItemPackageDTO getItem(int itemID) throws OperationFailedException {
        return getItem(itemID, 1);
    }

    /**
     * Fetches a specified quantity of an item based on the provided item ID.
     * 
     * @param itemID   The ID of the item to fetch.
     * @param quantity The quantity of the item to fetch.
     * @return ItemPackageDTO contaning all relevant View Layer information
     *         (ItemDTO, Quantity, runningTotalCost, runningTotalVAT).
     * @throws OperationsFailedException in case an Excpetion is catched regarding either
     *                                   database calls or ongoing Sale.
     */
    public ItemPackageDTO getItem(int itemID, int quantity) throws OperationFailedException {
        
        try {
            ItemDTO itemDTO = externalInventorySys.getItem(itemID, quantity);
            salesHandler.addItem(itemDTO, quantity);

            SaleDTO saleDTO = salesHandler.getSaleDTO();
            ItemPackageDTO salePackageDTO = new ItemPackageDTO(itemDTO, quantity, saleDTO.getSalePrice(), saleDTO.getSaleVAT());
            return salePackageDTO;

        } catch (DatabaseException | SaleException exc ) {
            throw new OperationFailedException(exc.getMessage(), exc);
        }
    }

    /**
     * Ends ongoing Sale.
     * 
     * Tells salesHandler to end current Sale.
     * The returned saleDTO is sent to check for discounts.
     * A new updated saleDTO is then returned.
     * 
     * @return saleDTO.
     * @throws OperationFailedException catched from discountSystem.
     */
    public SaleDTO endSale() throws OperationFailedException {

        SaleDTO saleDTO = salesHandler.endSale();
        getSaleDiscount(saleDTO);
        SaleDTO updatedSaleDTO = salesHandler.getSaleDTO();
        return updatedSaleDTO;
    }

    /**
     * Processes the payment for the current sale.
     * 
     * In case transaction succeeds then function calls updateSaleSystem which
     * updates External Systems and prints receipts.
     * PaymentDTO then returns relevant payment information.
     *
     * @param enumType The type of payment.
     * @param amountPaid The amount paid by the customer.
     * @return PaymentDTO.
     * @throws OperationFailedException in case either payment is invalid
     *                                  or call to database fails (updateSaleSystem).
     */
    public PaymentDTO Payment(PaymentType enumType, double amountPaid) throws OperationFailedException {
        
        PaymentDTO paymentDTO = new PaymentDTO(amountPaid, enumType, salesHandler.getSaleDTO());
        try {
            salesHandler.transaction(paymentDTO);
            updateSaleSystem();
            salesHandler.completeSale();
            return paymentDTO;
        }
        catch (DatabaseException | SaleException exc) {
            throw new OperationFailedException(exc.getMessage(), exc);
        }
    }

    /**
     * Updates External Systems and logs Receipt.
     * @throws DatabaseException in case call to database fails.
     */
    private void updateSaleSystem() throws DatabaseException {

        ReceiptDTO receiptDTO = getReceiptDTO();
        PaymentDTO paymentDTO = receiptDTO.getReceiptPayment();
        SaleDTO saleDTO = receiptDTO.getReceiptSale();

        cashRegister.updateCashRegister(paymentDTO);
        externalAccountingSys.logReceipt(receiptDTO);
        externalInventorySys.updateItemQuantity(saleDTO.getSaleItemList());
        printer.printReceipt(receiptDTO);

    }

    /**
     * Retrieves Discount based on specific CustomerID.
     * 
     * @param customerID trace for possible discounts.
     * @return Discount to be displayed.
     * @throws OperationFailedException in case call to Database fails.
     */
    public Discount getCustomerDiscount(int customerID) throws OperationFailedException {
        try {
            Discount discount = externalDiscountSys.getCustomerDiscount(customerID);
            salesHandler.compositeDiscountInstance().addDiscount(discount);
            return discount;

        } catch(DatabaseException dbe) {
            throw new OperationFailedException(dbe.getMessage(), dbe);
        }
    }

    /**
     * Collect all Cost & Item related Discounts as a composite Discount which is then passed on
     * to the SalesHandler's composite discount ('composite' treats plural and singular the same).
     * All discounts collected are then applied. 
     * 
     * @param saleDTO information on which to find and determine discounts.
     * @throws OperationFailedException in case call to database or business logic fails.
     */
    private void getSaleDiscount(SaleDTO saleDTO) throws OperationFailedException {
        try{
            CompositeDiscount compositeDiscount = externalDiscountSys.collectSaleDiscounts(saleDTO);
            salesHandler.compositeDiscountInstance().addDiscount(compositeDiscount);
            salesHandler.applyDiscount();
        } 
        catch(DatabaseException | SaleException dbe) {
            throw new OperationFailedException(dbe.getMessage(), dbe);
        }
    }

    /**
     * Get method for retreiving saleshandlers current Receipt.
     * @return ReceiptDTO.
     */
    public ReceiptDTO getReceiptDTO() {
        return salesHandler.getReceiptDTO();
    }
}
